<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSA0efaKVbz-LL31DrKXrxbMo-4hKTb36ZzpjYXY7laLH5AmJGKiQp2FqvtQh8mj3TV6Mo995225hYr/pub?gid=617184698&single=true&output=csv';
    const CATEGORIES = ['S√ºt√©s', 'F≈ëz√©s', 'S√ºt√©s √©s f≈ëz√©s n√©lk√ºl', 'Air Fryer', 'Magyaros', '√Åzsiai', 'Mediterr√°n', 'K√∂ret', 'Sal√°ta', 'F≈ë√©tel', 'Reggeli/Vacsora', 'Leves', '√âdes desszert', 'S√≥s desszert', 'Ital', 'Egy√©b', 'Tippek √©s tr√ºkk√∂k', 'Veget√°ri√°nus', 'Csirke', 'Halak √©s r√°kok', 'Marha/Sert√©s', 'Di√©t√°s', 'Gyors', 'Egyszer≈±'];

    let allRecipes = [];
    let enabledFilters = new Set();

    async function init() {
        createFilterButtons();
        try {
            const response = await fetch(SHEET_URL + '&cb=' + Date.now());
            const text = await response.text();
            
            const rows = text.split('\n').filter(line => line.trim() !== '');
            const headers = rows[0].split(',').map(h => h.replace(/^"|"$/g, '').trim());
            
            allRecipes = rows.slice(1).map(row => {
                const cells = row.match(/(".*?"|[^",\r\n]+)(?=\s*,|\s*$)/g) || [];
                let obj = {};
                headers.forEach((h, i) => {
                    let val = cells[i] || "";
                    obj[h] = val.replace(/^"|"$/g, '').trim();
                });
                return obj;
            }).filter(r => {
                // DUPLA BIZTOS√çT√âK:
                // Csak akkor vessz√ºk be, ha van neve √âS az ID oszlop√°ban benne van az "ID" sz√≥
                const hasName = r['Recept neve'] && r['Recept neve'].length > 1;
                const hasID = r['ID'] && r['ID'].toString().toUpperCase().includes('ID');
                return hasName && hasID;
            });

            allRecipes.sort((a, b) => a['Recept neve'].localeCompare(b['Recept neve'], 'hu'));
            document.getElementById('status-bar').innerText = `${allRecipes.length} recept bet√∂ltve`;
            render();
        } catch (err) {
            document.getElementById('status-bar').innerText = "Hiba a bet√∂lt√©skor.";
        }
    }

    // A render() √©s a t√∂bbi f√ºggv√©ny marad a legut√≥bbi stabil verzi√≥b√≥l...
    function createFilterButtons() {
        const grid = document.getElementById('filterGrid');
        grid.innerHTML = CATEGORIES.map(cat => `<label class="filter-item"><input type="checkbox" onchange="toggleFilter('${cat}', this)">${cat}</label>`).join('');
    }

    function toggleFilter(cat, checkbox) {
        checkbox.checked ? enabledFilters.add(cat) : enabledFilters.delete(cat);
        checkbox.parentElement.classList.toggle('active', checkbox.checked);
        render();
    }

    function render() {
        const container = document.getElementById('recipesContainer');
        const search = document.getElementById('searchInput').value.toLowerCase();
        
        const filtered = allRecipes.filter(r => {
            const content = `${r['Recept neve']} ${r['Hozz√°val√≥k']} ${r['ID']}`.toLowerCase();
            const matchesSearch = content.includes(search);
            if (enabledFilters.size === 0) return matchesSearch;
            return matchesSearch && Array.from(enabledFilters).every(cat => (r[cat] || '').toLowerCase() === 'x');
        });

        container.innerHTML = filtered.map(r => {
            const recipeUrl = (r['URL'] || '').trim();
            const imgVal = (r['K√©p'] || '').trim();
            let finalImg = "";

            if (imgVal.startsWith('http')) {
                finalImg = imgVal;
            } else if (!imgVal && (recipeUrl.includes('youtube.com') || recipeUrl.includes('youtu.be'))) {
                const vid = recipeUrl.match(/(?:youtu\.be\/|youtube\.com(?:\/embed\/|\/v\/|\/watch\?v=|\/user\/\S+|\/ytscreeningroom\?v=))([\w\-]{11})/);
                if (vid) finalImg = `https://img.youtube.com/vi/${vid[1]}/mqdefault.jpg`;
            }

            return `
                <div class="recipe-card">
                    <div class="recipe-img-container">
                        <div class="recipe-placeholder">ü•ò</div>
                        ${finalImg ? `<img src="${finalImg}" class="recipe-img" style="position:relative;z-index:2" onerror="this.style.display='none'">` : ''}
                    </div>
                    <div class="recipe-content">
                        <div style="font-size:0.7rem; color:#cbd5e1; margin-bottom:5px;">${r['ID']}</div>
                        <h2 class="recipe-title">${r['Recept neve']}</h2>
                        ${recipeUrl ? `<a href="${recipeUrl}" target="_blank" class="recipe-link">Megnyit√°s</a>` : ''}
                        <div class="recipe-details">
                            <div class="section-title">Hozz√°val√≥k:</div>
                            <div class="recipe-text">${r['Hozz√°val√≥k']}</div>
                            ${r['Le√≠r√°s'] ? `<div class="section-title">Le√≠r√°s:</div><div class="recipe-text">${r['Le√≠r√°s']}</div>` : ''}
                        </div>
                    </div>
                </div>`;
        }).join('');
    }

    document.getElementById('searchInput').addEventListener('input', render);
    init();
</script>
