<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Szakácskönyv Diagnosztika</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 10px; }
        #debug-log { background: #333; color: #0f0; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; overflow-x: auto; white-space: pre; margin-bottom: 20px; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        .filter-btn { display: inline-block; padding: 5px 10px; margin: 2px; background: #ddd; border-radius: 15px; cursor: pointer; font-size: 12px; }
        .active { background: #1e3c72; color: white; }
    </style>
</head>
<body>

    <h1>Szakácskönyv Betöltési Napló</h1>
    <div id="status-box" class="card">Státusz: <span id="status">Kezdés...</span></div>
    
    <h3>Nyers adatok (Debug):</h3>
    <div id="debug-log">Várakozás a Google válaszára...</div>

    <div id="filter-area" class="card" style="display:none;">
        <h4>Szűrők:</h4>
        <div id="filterGrid"></div>
    </div>

    <div id="recipesContainer"></div>

<script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSA0efaKVbz-LL31DrKXrxbMo-4hKTb36ZzpjYXY7laLH5AmJGKiQp2FqvtQh8mj3TV6Mo995225hYr/pub?output=csv';

    const CATEGORIES = ['Sütés', 'Főzés', 'Sütés és főzés nélkül', 'Magyaros', 'Ázsiai', 'Mediterrán', 'Köret', 'Saláta', 'Főétel', 'Reggeli/Vacsora', 'Leves', 'Édes desszert', 'Sós desszert', 'Ital', 'Egyéb', 'Vegetáriánus', 'Csirke', 'Halak és rákok', 'Marha/Sertés', 'Diétás', 'Gyors', 'Egyszerű'];

    let recipes = [];

    async function fetchData() {
        const log = document.getElementById('debug-log');
        const status = document.getElementById('status');

        try {
            status.innerText = "Adatok lekérése folyamatban...";
            const response = await fetch(CSV_URL + '&t=' + new Date().getTime());
            
            if (!response.ok) throw new Error("HTTP hiba: " + response.status);
            
            const rawData = await response.text();
            log.innerText = "Sikerült letölteni! Első 200 karakter:\n" + rawData.substring(0, 200);

            // CSV feldolgozás
            const lines = rawData.split(/\r?\n/).filter(line => line.trim() !== "");
            if (lines.length < 2) {
                status.innerHTML = "<span class='error'>A táblázat csak fejlécet tartalmaz vagy üres!</span>";
                return;
            }

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            log.innerText += "\n\nÉszlelt fejlécek: " + headers.join(' | ');

            recipes = lines.slice(1).map(line => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.trim().replace(/"/g, ''));
                let obj = {};
                headers.forEach((h, i) => obj[h] = values[i] || "");
                return obj;
            });

            status.innerHTML = `<span class='success'>${recipes.length} recept sikeresen feldolgozva!</span>`;
            document.getElementById('filter-area').style.display = 'block';
            
            renderFilters();
            renderRecipes(recipes);

        } catch (err) {
            status.innerHTML = "<span class='error'>Hiba történt: " + err.message + "</span>";
            log.innerText = "Hiba részletei: " + err.stack;
        }
    }

    function renderFilters() {
        const grid = document.getElementById('filterGrid');
        grid.innerHTML = CATEGORIES.map(c => `<span class="filter-btn active" onclick="this.classList.toggle('active'); runFilter();">${c}</span>`).join('');
    }

    function runFilter() {
        const activeFilters = Array.from(document.querySelectorAll('.filter-btn.active')).map(btn => btn.innerText);
        const filtered = recipes.filter(r => {
            // Ha minden szűrő aktív, mutassunk mindent
            if (activeFilters.length === CATEGORIES.length) return true;
            // Különben nézzük meg, van-e 'x' az aktív kategóriák valamelyikében
            return activeFilters.some(f => (r[f] || "").toLowerCase().includes('x'));
        });
        renderRecipes(filtered);
    }

    function renderRecipes(data) {
        const container = document.getElementById('recipesContainer');
        if (data.length === 0) {
            container.innerHTML = "<p>Nincs találat.</p>";
            return;
        }
        container.innerHTML = data.map(r => `
            <div class="card">
                <strong>${r['Recept neve'] || 'Névtelen'}</strong><br>
                <small>${r['Kategória'] || ''}</small>
                <p>${(r['Hozzávalók'] || "").substring(0, 100)}...</p>
                ${r['URL'] ? `<a href="${r['URL']}" target="_blank">Megnyitás</a>` : ''}
            </div>
        `).join('');
    }

    fetchData();
</script>
</body>
</html>
